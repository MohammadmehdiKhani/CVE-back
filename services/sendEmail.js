const nodemailer = require("nodemailer");
require("dotenv").config();
const mailgen = require("mailgen");

sendEmail = async (username, changedPrograms, destination) => {
  const transporter = nodemailer.createTransport({
    service: "hotmail",
    auth: {
      user: process.env.USER_EMAIL,
      pass: process.env.USER_EMAIL_PASSWORD,
    },
  });

  let mailGenerator = new mailgen({
    theme: "default",
    product: {
      name: "CVE alert",
      link: "https://github.com/MohammadmehdiKhani",
    },
  });

  let tableData = [];
  for (let i = 0; i < changedPrograms.length; i++) {
    const program = changedPrograms[i];
    tableData.push({ Programs: program });
  }
  let format = {
    body: {
      name: username,
      intro:
        "There are some new vulnerablilities published for these programs recently:",
      table: {
        data: tableData,
      },
      outro: "Go check them in CVE alert app.",
    },
  };

  let mail = mailGenerator.generate(format);
  const options = {
    from: process.env.USER_EMAIL,
    to: `${destination}`,
    subject: "CVE alert",
    html: mail,
  };

  transporter.sendMail(options, (err, info) => {
    if (err) {
      console.log(err);
      return;
    }
    console.log(info.response);
  });
};

module.exports = {
  sendEmail,
};
